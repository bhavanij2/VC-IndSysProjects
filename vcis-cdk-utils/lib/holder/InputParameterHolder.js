"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const AWS = require("aws-sdk");
const EnvironmentHolder_1 = require("./EnvironmentHolder");
const Tags_1 = require("../tags/Tags");
let inputParameters;
let inputParametersPromises;
let env;
class InputParameterHolder {
    static setup(node, loadTags = true) {
        inputParametersPromises = [];
        env = EnvironmentHolder_1.EnvironmentHolder.getEnv();
        const inputParams = node.getContext("InputParameters");
        if (inputParams === undefined) {
            throw Error("InputParameters needs to be defined on cdk.context file");
        }
        inputParameters = {};
        if (loadTags) {
            inputParams['generic'][Tags_1.Tags.tagKey] = Tags_1.Tags.tagsParameterStorePaths;
        }
        this.loadParametersFromPath(inputParams, 'generic');
        this.loadParametersFromPath(inputParams, env);
        return Promise.all(inputParametersPromises).then((params) => {
            const flatJson = params.reduce((obj, itm) => {
                obj[itm.paramName] = itm.value;
                return obj;
            }, {});
            inputParameters = this.unflatten(flatJson);
        });
    }
    static unflatten(data) {
        "use strict";
        if (Object(data) !== data || Array.isArray(data))
            return data;
        var regex = /\.?([^.\[\]]+)|\[(\d+)\]/g, resultholder = {};
        for (var p in data) {
            var cur = resultholder, prop = "", m;
            while (m = regex.exec(p)) {
                cur = cur[prop] || (cur[prop] = (m[2] ? [] : {}));
                prop = m[2] || m[1];
            }
            cur[prop] = data[p];
        }
        return resultholder[""] || resultholder;
    }
    ;
    static loadParametersFromPath(inputParams, rootParamPath) {
        const parameterStorePaths = inputParams[rootParamPath] ? inputParams[rootParamPath] : inputParams["non-prod"];
        this.populateParameters(parameterStorePaths);
    }
    static populateParameters(parameterStorePaths, fullKey) {
        if (parameterStorePaths) {
            Object.keys(parameterStorePaths).forEach(key => {
                const _fullKey = [fullKey, key].filter(key => key).join(".");
                const parameterValue = parameterStorePaths[key];
                if (typeof parameterValue === 'string') {
                    const parameterStringValue = parameterValue;
                    inputParametersPromises.push(this.fetchParameterValuePromise(parameterStringValue, _fullKey));
                }
                else {
                    this.populateParameters(parameterValue, _fullKey);
                }
            });
        }
    }
    static fetchParameterValuePromise(parameterValue, path) {
        const [prefix, paramValue, version] = parameterValue.split(":", 3);
        if (prefix.startsWith('ssm')) {
            if (version === undefined) {
                throw Error(`Version is required for entry ${paramValue}`);
            }
            return this.fetchParameterFromSSMAsync(paramValue, version, path);
        }
        return this.fetchConstantValueAsync(parameterValue, path);
    }
    static fetchConstantValueAsync(paramValue, path) {
        return new Promise(function (resolve) {
            resolve({ paramName: path, value: paramValue.replace('{ENV}', env) });
        });
    }
    static fetchParameterFromSSMAsync(paramValue, version, path) {
        const paramName = paramValue.replace('{ENV}', env);
        const ssm_sdk = new AWS.SSM();
        return ssm_sdk.getParameter({
            Name: `${paramName}:${version}`,
            WithDecryption: false
        }, function (err, data) {
            if (err) {
                console.log(err, err.stack); // an error occurred
                throw new Error(`Error occurred fetching param ${paramName}`);
            }
            else {
                if (data.Parameter === undefined) {
                    throw new Error(`Error occurred fetching param ${paramName}`);
                }
            }
        }).promise().then(result => {
            const _type = result.Parameter ? result.Parameter.Type : 'String';
            const _value = result.Parameter ? result.Parameter.Value : '';
            return {
                paramName: path,
                value: _type === 'StringList' && _value ? _value.split(",") : _value
            };
        }, error => { console.log(error); });
    }
}
InputParameterHolder.get = (paramName) => inputParameters[paramName];
exports.InputParameterHolder = InputParameterHolder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW5wdXRQYXJhbWV0ZXJIb2xkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJJbnB1dFBhcmFtZXRlckhvbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLCtCQUFnQztBQUNoQywyREFBd0Q7QUFDeEQsdUNBQW9DO0FBR3BDLElBQUksZUFBb0IsQ0FBQztBQUN6QixJQUFJLHVCQUF1QyxDQUFDO0FBQzVDLElBQUksR0FBVyxDQUFDO0FBRWhCLE1BQWEsb0JBQW9CO0lBRS9CLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBdUIsRUFBRSxXQUFvQixJQUFJO1FBQzVELHVCQUF1QixHQUFHLEVBQUUsQ0FBQztRQUM3QixHQUFHLEdBQUcscUNBQWlCLENBQUMsTUFBTSxFQUFFLENBQUM7UUFFakMsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3ZELElBQUksV0FBVyxLQUFLLFNBQVMsRUFBRTtZQUM3QixNQUFNLEtBQUssQ0FBQyx5REFBeUQsQ0FBQyxDQUFDO1NBQ3hFO1FBRUQsZUFBZSxHQUFHLEVBQUUsQ0FBQztRQUVyQixJQUFHLFFBQVEsRUFBQztZQUNWLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxXQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsV0FBSSxDQUFDLHVCQUF1QixDQUFDO1NBQ3BFO1FBRUQsSUFBSSxDQUFDLHNCQUFzQixDQUFDLFdBQVcsRUFBRSxTQUFTLENBQUMsQ0FBQztRQUNwRCxJQUFJLENBQUMsc0JBQXNCLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBRTlDLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQW1CLEVBQUUsRUFBRTtZQUN2RSxNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsR0FBUSxFQUFFLEdBQWMsRUFBRSxFQUFFO2dCQUMxRCxHQUFHLENBQUMs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QUssQ0FBQyxpQ0FBaUMsU0FBUyxFQUFFLENBQUMsQ0FBQzthQUMvRDtpQkFBTTtnQkFDTCxJQUFJLElBQUksQ0FBQyxTQUFTLEtBQUssU0FBUyxFQUFFO29CQUNoQyxNQUFNLElBQUksS0FBSyxDQUFDLGlDQUFpQyxTQUFTLEVBQUUsQ0FBQyxDQUFDO2lCQUMvRDthQUNGO1FBQ0gsQ0FBQyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO1lBQ3pCLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7WUFDbEUsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUM5RCxPQUFPO2dCQUNMLFNBQVMsRUFBRSxJQUFJO2dCQUNmLEtBQUssRUFBRSxLQUFLLEtBQUssWUFBWSxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTTthQUNyRSxDQUFBO1FBQ0gsQ0FBQyxFQUFFLEtBQUssQ0FBQyxFQUFFLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7O0FBR00sd0JBQUcsR0FBRyxDQUFDLFNBQWlCLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQztBQXJIakUsb0RBc0hDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNkayA9IHJlcXVpcmUoXCJAYXdzLWNkay9jZGtcIik7XG5pbXBvcnQgQVdTID0gcmVxdWlyZShcImF3cy1zZGtcIik7XG5pbXBvcnQgeyBFbnZpcm9ubWVudEhvbGRlciB9IGZyb20gXCIuL0Vudmlyb25tZW50SG9sZGVyXCI7XG5pbXBvcnQgeyBUYWdzIH0gZnJvbSAnLi4vdGFncy9UYWdzJztcblxuXG5sZXQgaW5wdXRQYXJhbWV0ZXJzOiBhbnk7XG5sZXQgaW5wdXRQYXJhbWV0ZXJzUHJvbWlzZXM6IFByb21pc2U8YW55PltdO1xubGV0IGVudjogc3RyaW5nO1xuXG5leHBvcnQgY2xhc3MgSW5wdXRQYXJhbWV0ZXJIb2xkZXIge1xuXG4gIHN0YXRpYyBzZXR1cChub2RlOiBjZGsuQ29uc3RydWN0Tm9kZSwgbG9hZFRhZ3M6IGJvb2xlYW4gPSB0cnVlKTogUHJvbWlzZTxhbnk+IHtcbiAgICBpbnB1dFBhcmFtZXRlcnNQcm9taXNlcyA9IFtdO1xuICAgIGVudiA9IEVudmlyb25tZW50SG9sZGVyLmdldEVudigpO1xuXG4gICAgY29uc3QgaW5wdXRQYXJhbXMgPSBub2RlLmdldENvbnRleHQoXCJJbnB1dFBhcmFtZXRlcnNcIik7XG4gICAgaWYgKGlucHV0UGFyYW1zID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IEVycm9yKFwiSW5wdXRQYXJhbWV0ZXJzIG5lZWRzIHRvIGJlIGRlZmluZWQgb24gY2RrLmNvbnRleHQgZmlsZVwiKTtcbiAgICB9XG5cbiAgICBpbnB1dFBhcmFtZXRlcnMgPSB7fTtcblxuICAgIGlmKGxvYWRUYWdzKXtcbiAgICAgIGlucHV0UGFyYW1zWydnZW5lcmljJ11bVGFncy50YWdLZXldID0gVGFncy50YWdzUGFyYW1ldGVyU3RvcmVQYXRocztcbiAgICB9XG5cbiAgICB0aGlzLmxvYWRQYXJhbWV0ZXJzRnJvbVBhdGgoaW5wdXRQYXJhbXMsICdnZW5lcmljJyk7XG4gICAgdGhpcy5sb2FkUGFyYW1ldGVyc0Zyb21QYXRoKGlucHV0UGFyYW1zLCBlbnYpO1xuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKGlucHV0UGFyYW1ldGVyc1Byb21pc2VzKS50aGVuKChwYXJhbXM6IGZsYXRQYXJhbVtdKSA9PiB7XG4gICAgICBjb25zdCBmbGF0SnNvbiA9IHBhcmFtcy5yZWR1Y2UoKG9iajogYW55LCBpdG06IGZsYXRQYXJhbSkgPT4ge1xuICAgICAgICBvYmpbaXRtLnBhcmFtTmFtZV0gPSBpdG0udmFsdWU7XG4gICAgICAgIHJldHVybiBvYmo7XG4gICAgICB9LCB7fSk7XG5cbiAgICAgIGlucHV0UGFyYW1ldGVycyA9IHRoaXMudW5mbGF0dGVuKGZsYXRKc29uKTtcbiAgICB9KTtcbiAgfVxuXG4gIHN0YXRpYyB1bmZsYXR0ZW4oZGF0YTogYW55KSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgaWYgKE9iamVjdChkYXRhKSAhPT0gZGF0YSB8fCBBcnJheS5pc0FycmF5KGRhdGEpKVxuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgdmFyIHJlZ2V4ID0gL1xcLj8oW14uXFxbXFxdXSspfFxcWyhcXGQrKVxcXS9nLFxuICAgICAgcmVzdWx0aG9sZGVyOiBhbnkgPSB7fTtcbiAgICBmb3IgKHZhciBwIGluIGRhdGEpIHtcbiAgICAgIHZhciBjdXI6IGFueSA9IHJlc3VsdGhvbGRlcixcbiAgICAgICAgcHJvcCA9IFwiXCIsXG4gICAgICAgIG07XG4gICAgICB3aGlsZSAobSA9IHJlZ2V4LmV4ZWMocCkpIHtcbiAgICAgICAgY3VyID0gY3VyW3Byb3BdIHx8IChjdXJbcHJvcF0gPSAobVsyXSA/IFtdIDoge30pKTtcbiAgICAgICAgcHJvcCA9IG1bMl0gfHwgbVsxXTtcbiAgICAgIH1cbiAgICAgIGN1cltwcm9wXSA9IGRhdGFbcF07XG4gICAgfVxuICAgIHJldHVybiByZXN1bHRob2xkZXJbXCJcIl0gfHwgcmVzdWx0aG9sZGVyO1xuICB9O1xuXG4gIHByaXZhdGUgc3RhdGljIGxvYWRQYXJhbWV0ZXJzRnJvbVBhdGgoaW5wdXRQYXJhbXM6IGFueSwgcm9vdFBhcmFtUGF0aDogc3RyaW5nKSB7XG4gICAgY29uc3QgcGFyYW1ldGVyU3RvcmVQYXRocyA9IGlucHV0UGFyYW1zW3Jvb3RQYXJhbVBhdGhdID8gaW5wdXRQYXJhbXNbcm9vdFBhcmFtUGF0aF0gOiBpbnB1dFBhcmFtc1tcIm5vbi1wcm9kXCJdO1xuICAgIHRoaXMucG9wdWxhdGVQYXJhbWV0ZXJzKHBhcmFtZXRlclN0b3JlUGF0aHMpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGF0aWMgcG9wdWxhdGVQYXJhbWV0ZXJzKHBhcmFtZXRlclN0b3JlUGF0aHM6IGFueSwgZnVsbEtleT86IHN0cmluZykge1xuICAgIGlmIChwYXJhbWV0ZXJTdG9yZVBhdGhzKSB7XG4gICAgICBPYmplY3Qua2V5cyhwYXJhbWV0ZXJTdG9yZVBhdGhzKS5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgIGNvbnN0IF9mdWxsS2V5ID0gW2Z1bGxLZXksIGtleV0uZmlsdGVyKGtleSA9PiBrZXkpLmpvaW4oXCIuXCIpO1xuICAgICAgICBjb25zdCBwYXJhbWV0ZXJWYWx1ZTogYW55ID0gcGFyYW1ldGVyU3RvcmVQYXRoc1trZXldO1xuICAgICAgICBpZiAodHlwZW9mIHBhcmFtZXRlclZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIGNvbnN0IHBhcmFtZXRlclN0cmluZ1ZhbHVlOiBzdHJpbmcgPSBwYXJhbWV0ZXJWYWx1ZTtcbiAgICAgICAgICBpbnB1dFBhcmFtZXRlcnNQcm9taXNlcy5wdXNoKHRoaXMuZmV0Y2hQYXJhbWV0ZXJWYWx1ZVByb21pc2UocGFyYW1ldGVyU3RyaW5nVmFsdWUsIF9mdWxsS2V5KSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgdGhpcy5wb3B1bGF0ZVBhcmFtZXRlcnMocGFyYW1ldGVyVmFsdWUsIF9mdWxsS2V5KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGZldGNoUGFyYW1ldGVyVmFsdWVQcm9taXNlKHBhcmFtZXRlclZhbHVlOiBzdHJpbmcsIHBhdGg6IHN0cmluZykge1xuICAgIGNvbnN0IFtwcmVmaXgsIHBhcmFtVmFsdWUsIHZlcnNpb25dID0gcGFyYW1ldGVyVmFsdWUuc3BsaXQoXCI6XCIsIDMpO1xuXG4gICAgaWYgKHByZWZpeC5zdGFydHNXaXRoKCdzc20nKSkge1xuICAgICAgaWYgKHZlcnNpb24gPT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aHJvdyBFcnJvcihgVmVyc2lvbiBpcyByZXF1aXJlZCBmb3IgZW50cnkgJHtwYXJhbVZhbHVlfWApXG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzLmZldGNoUGFyYW1ldGVyRnJvbVNTTUFzeW5jKHBhcmFtVmFsdWUsIHZlcnNpb24sIHBhdGgpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmZldGNoQ29uc3RhbnRWYWx1ZUFzeW5jKHBhcmFtZXRlclZhbHVlLCBwYXRoKTtcbiAgfVxuXG4gIHN0YXRpYyBmZXRjaENvbnN0YW50VmFsdWVBc3luYyhwYXJhbVZhbHVlOiBzdHJpbmcsIHBhdGg6IHN0cmluZykge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSkge1xuICAgICAgcmVzb2x2ZSh7IHBhcmFtTmFtZTogcGF0aCwgdmFsdWU6IHBhcmFtVmFsdWUucmVwbGFjZSgne0VOVn0nLCBlbnYpIH0pO1xuICAgIH0pXG4gIH1cblxuXG4gIHN0YXRpYyBmZXRjaFBhcmFtZXRlckZyb21TU01Bc3luYyhwYXJhbVZhbHVlOiBzdHJpbmcsIHZlcnNpb246IGFueSwgcGF0aDogc3RyaW5nKSB7XG4gICAgY29uc3QgcGFyYW1OYW1lID0gcGFyYW1WYWx1ZS5yZXBsYWNlKCd7RU5WfScsIGVudik7XG4gICAgY29uc3Qgc3NtX3NkayA9IG5ldyBBV1MuU1NNKCk7XG4gICAgcmV0dXJuIHNzbV9zZGsuZ2V0UGFyYW1ldGVyKHtcbiAgICAgIE5hbWU6IGAke3BhcmFtTmFtZX06JHt2ZXJzaW9ufWAsXG4gICAgICBXaXRoRGVjcnlwdGlvbjogZmFsc2VcbiAgICB9LCBmdW5jdGlvbiAoZXJyLCBkYXRhKSB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGVyciwgZXJyLnN0YWNrKTsgLy8gYW4gZXJyb3Igb2NjdXJyZWRcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFcnJvciBvY2N1cnJlZCBmZXRjaGluZyBwYXJhbSAke3BhcmFtTmFtZX1gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmIChkYXRhLlBhcmFtZXRlciA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFcnJvciBvY2N1cnJlZCBmZXRjaGluZyBwYXJhbSAke3BhcmFtTmFtZX1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0pLnByb21pc2UoKS50aGVuKHJlc3VsdCA9PiB7XG4gICAgICBjb25zdCBfdHlwZSA9IHJlc3VsdC5QYXJhbWV0ZXIgPyByZXN1bHQuUGFyYW1ldGVyLlR5cGUgOiAnU3RyaW5nJztcbiAgICAgIGNvbnN0IF92YWx1ZSA9IHJlc3VsdC5QYXJhbWV0ZXIgPyByZXN1bHQuUGFyYW1ldGVyLlZhbHVlIDogJyc7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBwYXJhbU5hbWU6IHBhdGgsXG4gICAgICAgIHZhbHVlOiBfdHlwZSA9PT0gJ1N0cmluZ0xpc3QnICYmIF92YWx1ZSA/IF92YWx1ZS5zcGxpdChcIixcIikgOiBfdmFsdWVcbiAgICAgIH1cbiAgICB9LCBlcnJvciA9PiB7IGNvbnNvbGUubG9nKGVycm9yKSB9KTtcbiAgfVxuXG5cbiAgc3RhdGljIGdldCA9IChwYXJhbU5hbWU6IHN0cmluZykgPT4gaW5wdXRQYXJhbWV0ZXJzW3BhcmFtTmFtZV07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgZmxhdFBhcmFtIHtcbiAgcGFyYW1OYW1lOiBzdHJpbmc7XG4gIHZhbHVlOiBzdHJpbmc7XG59XG5cbiJdfQ==